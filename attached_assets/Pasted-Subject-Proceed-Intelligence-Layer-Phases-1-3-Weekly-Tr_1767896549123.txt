Subject: Proceed: Intelligence Layer Phases 1–3 + Weekly Trends Page (/trends)

Team — confirmed details and ready to proceed.

Confirmed current state

* company_relationships table: EXISTS
* Relationships: PERSISTED (stored in DB with source_signal_id, confidence, timestamps). Industry Map reads from DB.
* Signals: single primary companyId per signal (no multi-company signals today).
* Priority: INDUSTRY-LEVEL trends first (faster aggregation + headline value). Company-level can drill down later.

Please proceed with Implementation Plan — Phases 1–3 (themes + metrics + trends) and add an MVP weekly report-style Trends page.

PHASE 1 — Theme Extraction (Foundation)

1. Add themes array to signals schema

* Add themes text[] column to signals in shared/schema.ts
* Run migration via npm run db:push
* Update insert/select types
* Also add themes_version int default 1 (or themes_model_version text) so we can evolve taxonomy safely.

2. Implement AI theme extraction during signal analysis

* Modify server/ai-analysis.ts to extract themes alongside entity/sentiment/priority.
* Return 1–5 normalized themes per signal.
* Use this base taxonomy (snake_case):

  * hiring_pressure
  * capacity_expansion
  * regulatory_risk
  * supply_chain
  * m_a_activity
  * market_expansion
  * cost_pressures
  * sustainability
  * leadership_change
  * product_innovation
* Allow fallback theme other:<short_tag> if signal doesn’t match taxonomy.

3. Backfill endpoint for existing signals

* Create POST /api/signals/backfill-themes
* Process in batches (50) with rate limiting
* Provide progress tracking consistent with existing monitoring progress pattern

PHASE 2 — Rolling Metrics Storage
4) Create signal_metrics table
Fields:

* id (serial)
* scope_type (industry | company | theme)
* scope_id (text)
* signal_type (text, nullable)
* theme (text, nullable)
* period (7d | 30d | prev_30d)
* current_count (integer)
* prev_count (integer, nullable)
* delta_percent (numeric, nullable) where delta_percent = (current_count - prev_count) / nullif(prev_count,0)
* captured_at (timestamp)

Indexes (important for performance):

* (captured_at, scope_type)
* (scope_type, scope_id, period)
* (theme, period, captured_at)

5. Daily metrics snapshot job

* Add to server/scheduler.ts (runs daily after monitoring completes)
* Calculate counts for each industry, signal type, and theme
* Store 7d, 30d, prev_30d windows and computed delta_percent

PHASE 3 — Trend Intelligence
6) Create trends table
Fields:

* id (serial)
* scope_type (industry | company | region | theme)
* scope_id (text)
* signal_types (text[])
* themes (text[])
* time_window (7d | 30d | 90d)
* direction (up | down | flat)
* magnitude (numeric) // use delta_percent
* confidence (integer 0–100)
* explanation (text) // AI-generated narrative
* generated_at (timestamp)

7. Weekly trend generation job (TREND_CRON configurable)

* Trends should be discovered deterministically from metrics, then explained by AI (AI should not “find” trends from scratch).
* Candidate selection rules (tunable but start here):

  * current_count >= 10
  * abs(delta_percent) >= 0.25
  * choose top N movers per industry + window
* AI generates explanation text and store trend record.

MVP Weekly Report-Style Trends Page
Frontend:

* Add sidebar nav item: “Trends”
* New page route: /trends
* Weekly report style layout (not analytics table)

  * Filters: Industry dropdown (All + each industry), Time window (7d/30d/90d)
  * Cards list: title/headline, magnitude (+/-%), direction, confidence, explanation
  * “View underlying signals” link should open signals page filtered appropriately (industry + themes/signal_types + time window)

Backend:

* Create GET /api/trends?industry=...&window=...
* Return trends plus enough metadata to drive the “View underlying signals” filter payload.

Definition of Done (for this sprint)

* themes stored on signals and backfilled for existing records
* signal_metrics populated by daily job
* trends generated by weekly job and returned via /api/trends
* /trends page renders a weekly report-style view with working clickthrough to underlying signals

Please confirm:

1. Any blockers with schema migrations in current environment
2. Whether you want themes extraction to run at ingestion time, analysis time, or both (I suggest analysis time first)
3. ETA for Phase 1–3 + /trends MVP
